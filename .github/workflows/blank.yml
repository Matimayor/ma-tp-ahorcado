name: Continuous Integration

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install

      - name: Run tests and capture results
        run: |
          npm test -- --json --outputFile=test-results.json
          cat test-results.json

      - name: Calculate average passing rate
        run: |
          const fs = require('fs');
          
          fs.readFile('test-results.json', 'utf8', (err, data) => {
            if (err) {
              console.error(err);
              return;
            }
            
            try {
              const results = JSON.parse(data);
              const totalTests = results.numTotalTests;
              const totalPassed = results.numPassedTests;
              const average = (totalPassed / totalTests) * 100;
              
              console.log(`Average passing rate: ${average.toFixed(2)}%`);
            } catch (error) {
              console.error('Error parsing JSON:', error);
            }
          });
